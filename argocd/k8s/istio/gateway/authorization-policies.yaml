# Allow all
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-all
  namespace: whispr-prod
spec:
  rules:
    - {}

# --> Default: DENY ALL
# apiVersion: security.istio.io/v1
# kind: AuthorizationPolicy
# metadata:
#   name: deny-all
#   namespace: test
# spec:
#   {} # Empty spec = deny all traffic by default

#---
# --> Enable Ingress Gateway to App A
# apiVersion: security.istio.io/v1
# kind: AuthorizationPolicy
# metadata:
#   name: allow-gateway-to-app-a
#   namespace: test
# spec:
#   selector:
#     matchLabels:
#       app: app-a
#   action: ALLOW
#   rules:
#   - from:
#     - source:
#         namespaces: ["cluster.local/ns/test/sa/istio-gateway"]
#     to:
#     - operation:
#         methods: ["GET", "POST"]
#         paths: ["/*"]

#---
# --> Enable App A to App B
# apiVersion: security.istio.io/v1
# kind: AuthorizationPolicy
# metadata:
#   name: allow-app-a-to-app-b
#   namespace: test
# spec:
#   selector:
#     matchLabels:
#       app: app-b
#   action: ALLOW
#   rules:
#   - from:
#     - source:
#         principals: ["cluster.local/ns/test/sa/app-a"]
#     to:
#     - operation:
#         methods: ["GET"]
#         paths: ["/*"]

---
# --> Allow egress to databases
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-egress-databases
  namespace: whispr-prod
spec:
  action: ALLOW
  rules:
  # Allow egress to PostgreSQL (port 5432)
  - to:
    - operation:
        ports: ["5432"]
      destination:
        hosts:
          - "postgresql.whispr-prod.svc.cluster.local"
          - "postgresql.postgresql.svc.cluster.local"
  # Allow egress to Redis (port 6379)
  - to:
    - operation:
        ports: ["6379"]
      destination:
        hosts:
          - "redis.whispr-prod.svc.cluster.local"
          - "redis.redis.svc.cluster.local"
          - "redis-master.whispr-prod.svc.cluster.local"
  # Allow egress to gRPC services (port 50051, 50052, 50053)
  - to:
    - operation:
        ports: ["50051", "50052", "50053"]
  # Allow internal traffic (port 80, 443)
  - to:
    - operation:
        ports: ["80", "443", "3000", "3001", "4000", "4001"]

---
# --> PeerAuthentication : mTLS STRICT
apiVersion: security.istio.io/v1
kind: PeerAuthentication
metadata:
  name: default
  namespace: whispr-prod
spec:
  mtls:
    mode: STRICT # Force mTLS
