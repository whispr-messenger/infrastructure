apiVersion: batch/v1
kind: Job
metadata:
  name: vault-bootstrap-job
  namespace: vault
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
    argocd.argoproj.io/sync-wave: "5"
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: vault-config
      restartPolicy: OnFailure
      containers:
        - name: vault-config
          image: ghcr.io/whispr-messenger/vault-config-job:latest
          env:
            - name: VAULT_ADDR
              value: http://vault.vault.svc:8200
            - name: VAULT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: vault-root-token
                  key: root_token
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql
                  key: postgres-password
          command:
            - /bin/sh
            - -c
            - |
              set -e

              apk add --no-cache postgresql-client openssl curl

              curl -LO "https://dl.k8s.io/release/v1.28.3/bin/linux/amd64/kubectl"
              chmod +x kubectl
              mv kubectl /usr/local/bin/

              echo "Waiting for Vault to be ready and unsealed..."
              until vault status | grep -q "Sealed.*false"; do
                echo "Vault not ready or still sealed, waiting..."
                sleep 5
              done

              echo "Vault is ready, starting bootstrap..."

              ####################################################################################################
              # Enable engines
              ####################################################################################################
              vault auth enable kubernetes 2>/dev/null || echo "Kubernetes auth already enabled"
              vault secrets enable database 2>/dev/null || echo "Database secrets engine already enabled"
              vault secrets enable -path=kv kv-v2 2>/dev/null || echo "KV secrets engine already enabled"
              vault auth enable github 2>/dev/null || echo "GitHub auth already enabled"
              vault write auth/github/config organization=whispr-messenger

              ####################################################################################################
              # Kubernetes auth configuration
              ####################################################################################################
              vault write auth/kubernetes/config \
                kubernetes_host=https://kubernetes.default.svc:443 \
                kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt

              ####################################################################################################
              # Vault Config Operator bootstrap (policy + role for VCO service account)
              ####################################################################################################
              vault policy write vco-admin - <<EOF
              path "/*" {
                capabilities = ["create", "read", "update", "delete", "list", "sudo"]
              }
              EOF

              vault write auth/kubernetes/role/vco-admin \
                bound_service_account_names=vault-config-operator-controller-manager \
                bound_service_account_namespaces=vault-config-operator-system \
                policies=vco-admin \
                ttl=1h

              ####################################################################################################
              # JWT key generation (one-time)
              ####################################################################################################
              if ! vault kv get kv/whispr/shared/jwt >/dev/null 2>&1; then
                echo "Generating JWT RSA keys..."
                openssl genrsa -out /tmp/jwt_private.pem 2048
                openssl rsa -in /tmp/jwt_private.pem -pubout -out /tmp/jwt_public.pem

                vault kv put kv/whispr/shared/jwt JWT_PUBLIC_KEY="$(cat /tmp/jwt_public.pem)"
                vault kv put kv/whispr/auth-service/jwt JWT_PRIVATE_KEY="$(cat /tmp/jwt_private.pem)"

                rm /tmp/jwt_private.pem /tmp/jwt_public.pem
                echo "JWT keys generated and stored"
              else
                echo "JWT keys already exist in Vault"
              fi

              ####################################################################################################
              # Redis database connection (re-syncs password on every run)
              ####################################################################################################
              REDIS_PASSWORD=$(kubectl get secret -n redis redis -o jsonpath='{.data.redis-password}' | base64 -d)

              if [ -z "$REDIS_PASSWORD" ]; then
                echo "ERROR: Redis password is empty"
                exit 1
              fi

              vault write database/config/redis \
                plugin_name=redis-database-plugin \
                allowed_roles="*" \
                host=redis.redis.svc.cluster.local \
                port=6379 \
                username="default" \
                password="$REDIS_PASSWORD" \
                verify_connection=true

              ####################################################################################################
              # PostgreSQL database connection (first time only)
              ####################################################################################################
              export PGPASSWORD="$POSTGRES_PASSWORD"

              if vault read database/config/postgres >/dev/null 2>&1; then
                echo "PostgreSQL connection already configured, skipping"
              else
                vault write database/config/postgres \
                  plugin_name=postgresql-database-plugin \
                  allowed_roles="*" \
                  connection_url="postgresql://{{username}}:{{password}}@postgresql.postgresql.svc.cluster.local:5432/postgres?sslmode=disable" \
                  username="postgres" \
                  password="$POSTGRES_PASSWORD"
              fi

              ####################################################################################################
              # PostgreSQL databases and schema grants
              ####################################################################################################
              for svc in auth-service user-service messaging-service notification-service media-service scheduling-service; do
                svc_underscore=$(echo $svc | tr '-' '_')
                DB_NAME="${svc_underscore}_db"

                psql -h postgresql.postgresql.svc.cluster.local -U postgres \
                  -c "CREATE DATABASE \"${DB_NAME}\";" || echo "Database ${DB_NAME} already exists"

                psql -h postgresql.postgresql.svc.cluster.local -U postgres -d "${DB_NAME}" \
                  -c "GRANT ALL ON SCHEMA public TO PUBLIC;"
              done

              echo "Vault bootstrap completed. Microservice roles, policies and auth roles are managed by Vault Config Operator CRs."
