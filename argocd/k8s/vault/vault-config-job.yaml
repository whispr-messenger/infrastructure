apiVersion: batch/v1
kind: Job
metadata:
  name: vault-config-job
  namespace: vault
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
    argocd.argoproj.io/sync-wave: "5"
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: vault-config
      restartPolicy: OnFailure
      containers:
        - name: vault-config
          image: ghcr.io/whispr-messenger/vault-config-job:latest
          env:
            - name: VAULT_ADDR
              value: http://vault.vault.svc:8200
            - name: VAULT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: vault-root-token
                  key: root_token
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql
                  key: postgres-password
          command:
            - /bin/sh
            - -c
            - |
              set -e

              # Install postgresql-client for psql
              apk add --no-cache postgresql-client

              echo "Waiting for Vault to be ready and unsealed..."
              until vault status | grep -q "Sealed.*false"; do
                echo "Vault not ready or still sealed, waiting..."
                sleep 5
              done

              echo "Vault is ready, starting configuration..."

              ####################################################################################################
              # Activate the required engines
              ####################################################################################################
              echo "Enabling auth engines..."
              vault auth enable kubernetes 2>/dev/null || echo "Kubernetes auth already enabled"
              vault secrets enable database 2>/dev/null || echo "Database secrets engine already enabled"
              vault secrets enable -path=kv kv-v2 2>/dev/null || echo "KV secrets engine already enabled"
              
              echo "Enabling GitHub auth..."
              vault auth enable github 2>/dev/null || echo "GitHub auth already enabled"
              vault write auth/github/config organization=whispr-messenger

              ####################################################################################################
              # Redis configuration
              ####################################################################################################
              echo "Configuring Redis database connection..."
              
              # Get Redis password if not already available
              REDIS_PASSWORD=$(kubectl get secret -n redis redis -o jsonpath='{.data.redis-password}' | base64 -d)
              echo "Redis password character count: $(echo -n "$REDIS_PASSWORD" | wc -c)"

              # Use redis-node-1 which we identified as current master
              vault write database/config/redis \
                plugin_name=redis-database-plugin \
                allowed_roles="*" \
                host=redis-node-1.redis-headless.redis.svc.cluster.local \
                port=6379 \
                username="default" \
                password="$REDIS_PASSWORD"

              echo "Redis connection configured successfully"

              ####################################################################################################
              # Trust configuration
              ####################################################################################################
              echo "Configuring Kubernetes auth..."
              vault write auth/kubernetes/config \
                kubernetes_host=https://kubernetes.default.svc:443 \
                kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt

              ####################################################################################################
              # Create the authentication role
              ####################################################################################################
              echo "Creating vault-admin role..."
              vault write auth/kubernetes/role/vault-admin \
                bound_service_account_names=default,argocd-server \
                bound_service_account_namespaces=default,argocd \
                policies=vault-admin \
                ttl=1h

              ####################################################################################################
              # Define the policy for the "vault-admin" role
              ####################################################################################################
              echo "Creating vault-admin policy..."
              vault policy write vault-admin - <<EOF
                path "/*" {
                  capabilities = ["create", "read", "update", "delete", "list", "sudo"]
                }
              EOF

              ####################################################################################################
              # Configure PostgreSQL database connection
              ####################################################################################################
              echo "Configuring PostgreSQL database connection..."
              
              # Use the injected password
              export PGPASSWORD="$POSTGRES_PASSWORD"
              
              # Configure the database connection
              vault write database/config/postgres \
                plugin_name=postgresql-database-plugin \
                allowed_roles="*" \
                connection_url="postgresql://{{username}}:{{password}}@postgresql.postgresql.svc.cluster.local:5432/postgres?sslmode=disable" \
                username="postgres" \
                password="$POSTGRES_PASSWORD"
              
              echo "PostgreSQL connection configured successfully"

              ####################################################################################################
              # Microservices DB & Redis credentials: databases, roles, policies, k8s auth
              ####################################################################################################
              echo "Configuring microservices..."
              
              # Define Redis DB mapping
              # auth: 0, user: 1, messaging: 2, notification: 3, media: 4, scheduling: 5
              index=0
              
              for svc in auth-service user-service messaging-service notification-service media-service scheduling-service; do
                echo "Configuring ${svc}..."
                
                # Replace hyphens with underscores for database and role names to avoid SQL syntax issues
                svc_underscore=$(echo $svc | tr '-' '_')
                DB_NAME="${svc_underscore}_db"
                ROLE_NAME="role_${svc_underscore}"
                REDIS_ROLE_NAME="redis_role_${svc_underscore}"
                REDIS_DB=$index
                
                echo "Creating database ${DB_NAME} if it doesn't exist..."
                psql -h postgresql.postgresql.svc.cluster.local -U postgres -c "CREATE DATABASE \"${DB_NAME}\";" || echo "Database ${DB_NAME} already exists or error creating it"
                
                # Grant permissions on public schema so dynamic roles can create tables (Postgres 15+)
                echo "Granting permissions on public schema in ${DB_NAME}..."
                psql -h postgresql.postgresql.svc.cluster.local -U postgres -d "${DB_NAME}" -c "GRANT ALL ON SCHEMA public TO PUBLIC;"

                # Database role for the microservice
                vault write database/roles/${ROLE_NAME} \
                  db_name=postgres \
                  creation_statements="CREATE ROLE \"{{name}}\" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}'; GRANT CONNECT ON DATABASE \"${DB_NAME}\" TO \"{{name}}\"; GRANT ALL PRIVILEGES ON DATABASE \"${DB_NAME}\" TO \"{{name}}\";" \
                  default_ttl="1h" \
                  max_ttl="24h"

                # Redis role for the microservice (isolation using Redis ACLs for all keys and commands)
                # Note: Redis ACLs don't support strict DB isolation by index, so we grant access to all.
                if [ "${svc}" != "notification-service" ]; then
                  vault write database/roles/${REDIS_ROLE_NAME} \
                    db_name=redis \
                    creation_statements="[\"ACL SETUSER {{username}} on >{{password}} ~* &* +@all\"]" \
                    default_ttl="1h" \
                    max_ttl="24h"
                fi

                # Policy for the microservice (access only to its credentials path)
                vault policy write ${svc}-policy - <<EOF
                  path "database/creds/${ROLE_NAME}" {
                    capabilities = ["read"]
                  }
                  $( [ "${svc}" != "notification-service" ] && echo "path \"database/creds/${REDIS_ROLE_NAME}\" { capabilities = [\"read\"] }" )
              EOF

                # Kubernetes authentication role for the microservice
                vault write auth/kubernetes/role/${svc} \
                  bound_service_account_names=${svc}-sa \
                  bound_service_account_namespaces=whispr-prod \
                  policies=${svc}-policy \
                  ttl=1h
                  
                index=$((index + 1))
              done

              echo "Vault configuration completed successfully!"
