# PostgreSQL configuration for GKE cluster
# Shared PostgreSQL instance for all Whispr microservices
# Each microservice manages its own database via migrations
# Using bitnamilegacy repository due to Bitnami catalog migration

## Image overrides - use legacy repository due to Bitnami catalog migration
image:
  registry: docker.io
  repository: bitnamilegacy/postgresql
  tag: "17.2.0-debian-12-r9"

# PostgreSQL authentication
auth:
  # Enable "postgres" admin user 
  enablePostgresUser: true

# Architecture configuration
architecture: standalone

# Primary instance configuration
primary:
  persistence:
    enabled: true
    size: 50Gi
    storageClass: "standard-rwo"

  resources:
    requests:
      memory: "1Gi"
      cpu: "500m"
    limits:
      memory: "4Gi"
      cpu: "2000m"

  # PostgreSQL configuration parameters
  extendedConfiguration: |
    max_connections = 200
    shared_buffers = 256MB
    effective_cache_size = 1GB
    work_mem = 4MB
    maintenance_work_mem = 128MB

  # Pod annotations to force restart
  podAnnotations:
    whispr.dev/restartedAt: "2025-10-06T18:35:00Z"

  podSecurityContext:
    enabled: true
    fsGroup: 1001
    runAsUser: 1001
    runAsNonRoot: true

  containerSecurityContext:
    enabled: true
    allowPrivilegeEscalation: false
    runAsNonRoot: true
    runAsUser: 1001
    capabilities:
      drop:
        - ALL
    seccompProfile:
      type: RuntimeDefault

# Metrics and monitoring
# Disabled due to compatibility issues with bitnamilegacy images
# The metrics exporter expects secrets in a different path format
metrics:
  enabled: false

# Backup configuration
backup:
  enabled: false

# Security context
volumePermissions:
  enabled: true
  image:
    registry: docker.io
    repository: bitnamilegacy/os-shell
    tag: "12-debian-12-r36"

# Pod Annotations
commonAnnotations:
  "whispr.dev/component": "database"
  "whispr.dev/team": "platform"

# Pod Labels
commonLabels:
  app.kubernetes.io/part-of: "whispr"
  app.kubernetes.io/component: "database"
