---
# ServiceAccount for vault-init Job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-init
  namespace: vault

---
# ServiceAccount for vault-config Job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-config
  namespace: vault

---
# Role with permissions to manage Secrets (used by vault-init)
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: vault-init-role
  namespace: vault
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["create", "get", "update", "patch"]

---
# RoleBinding for vault-init ServiceAccount
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: vault-init-binding
  namespace: vault
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: vault-init-role
subjects:
  - kind: ServiceAccount
    name: vault-init
    namespace: vault

---
# Role for vault-config to read specific secrets in vault namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: vault-config-role
  namespace: vault
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames: ["vault-root-token", "vault-unseal-keys"]
    verbs: ["get"]

---
# RoleBinding for vault-config ServiceAccount in vault namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: vault-config-binding
  namespace: vault
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: vault-config-role
subjects:
  - kind: ServiceAccount
    name: vault-config
    namespace: vault

---
# Role in postgresql namespace to read the postgresql secret
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: vault-config-postgresql-reader
  namespace: postgresql
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames: ["postgresql"]
    verbs: ["get"]

---
# RoleBinding in postgresql namespace for vault-config
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: vault-config-postgresql-reader
  namespace: postgresql
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: vault-config-postgresql-reader
subjects:
  - kind: ServiceAccount
    name: vault-config
    namespace: vault

---
# Role in redis namespace to manage the redis secret and discover master pod
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: vault-config-redis-manager
  namespace: redis
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create", "update", "patch"]
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]

---
# RoleBinding in redis namespace for vault-config
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: vault-config-redis-manager
  namespace: redis
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: vault-config-redis-manager
subjects:
  - kind: ServiceAccount
    name: vault-config
    namespace: vault

---
# Role in whispr-prod namespace to delete stale Redis credential secrets.
# Used by the vault-redis-master-sync CronJob (Step 6) to force VSO rotation
# when a Redis restart wipes the in-memory ACL users created by Vault.
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: vault-config-whispr-redis-health
  namespace: whispr-prod
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames:
      - auth-service-redis-secret
      - user-service-redis-secret
      - media-service-redis-secret
      - messaging-service-redis-secret
      - scheduling-service-redis-secret
    verbs: ["delete"]

---
# RoleBinding in whispr-prod namespace for vault-config
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: vault-config-whispr-redis-health
  namespace: whispr-prod
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: vault-config-whispr-redis-health
subjects:
  - kind: ServiceAccount
    name: vault-config
    namespace: vault
