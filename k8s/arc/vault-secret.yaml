---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: arc-runner-sa
  namespace: arc-runners
---
# Allow the ARC controller (in arc-systems) to read secrets in arc-runners
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: arc-controller-secret-reader
  namespace: arc-runners
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["rbac.authorization.k8s.io"]
    resources: ["roles", "rolebindings"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: [""]
    resources: ["serviceaccounts"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: arc-controller-secret-reader
  namespace: arc-runners
subjects:
  - kind: ServiceAccount
    name: arc-controller-gha-rs-controller
    namespace: arc-systems
roleRef:
  kind: Role
  name: arc-controller-secret-reader
  apiGroup: rbac.authorization.k8s.io
---
# VSO VaultConnection for the arc-runners namespace
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultConnection
metadata:
  name: default
  namespace: arc-runners
spec:
  address: http://vault.vault.svc:8200
  skipTLSVerify: true
---
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultAuth
metadata:
  name: arc-runner-vault-auth
  namespace: arc-runners
spec:
  vaultConnectionRef: default
  method: kubernetes
  mount: kubernetes
  kubernetes:
    role: arc-runner
    serviceAccount: arc-runner-sa
    audiences:
      - vault
---
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: arc-github-pat
  namespace: arc-runners
spec:
  vaultAuthRef: arc-runner-vault-auth
  mount: kv
  type: kv-v2
  path: whispr/shared/github-arc
  destination:
    name: arc-github-pat-secret
    create: true
  refreshAfter: 1h
